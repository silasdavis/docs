version: 2

jobs:
  build:
    docker:
      - image: node:9-alpine
    steps:
      - add_ssh_keys:
          fingerprints:
            - "93:8d:84:15:24:16:74:77:07:80:ff:3a:a1:e5:d7:76"
      - run:
          name: "Install Git"
          command: |
            apk add --no-cache --update git openssh-client
            mkdir -p $HOME/.ssh && chmod 700 $HOME/.ssh
      - run:
          name: "Configure SSH"
          command: |
            echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > $HOME/.ssh/config
            git config --global user.name "Billings, a Bot"
            git config --global user.email "billings@monax.io"
      - checkout
      - run:
          name: "NPM Install"
          command: npm install
      - run:
          name: "NPM Test"
          command: npm test
      - run:
          name: "Build & Merge to Master"
          command: |
            git clone git@github.com:agreements-network/docs build
            npm run-script build
            cd build
            git add -A :/
            git commit -m "Automatic document generation: $CIRCLE_SHA1 [ci skip]" || true
            git push origin master

workflows:
  version: 2
  build:
    jobs:
      - build:
          filter:
            branch:
              only:
                - staging
